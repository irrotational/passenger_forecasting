/* BA-Only Data */
WITH BA_DATA AS
(SELECT FSPI.DEP_TM AS BA_TIME,FSPI.OBSERVATION_DT,
/* Trim leading 'BA' off the flight number. */
TRIM(LEADING 'A' FROM TRIM(LEADING 'B' FROM FSPI.FLT_LIST_TXT) ) AS OPG_FLT_NO,
FSPI.DEP_STN_CD,
FSPI.ARR_STN_CD,FSPI.DEP_DT,
MIN(FSPI.PRICE_VLU) AS MIN_BA_PRICE,
FSPI.DEP_DT-FSPI.OBSERVATION_DT AS DTD

FROM REF_STATION_HAUL RSH

LEFT JOIN FLT_SPOT_PRICE_EACH_WAY FSPI
ON
RSH.UPL_STN_CD = FSPI.DEP_STN_CD
AND
RSH.DSG_STN_CD = FSPI.ARR_STN_CD
WHERE
FSPI.DEP_DT BETWEEN DATE '2018-03-01' AND DATE '2020-02-01'
AND
FSPI.ALN_CD = 'BA'
AND
(FSPI.DEP_STN_CD = 'LHR' OR FSPI.ARR_STN_CD = 'LGW' OR FSPI.ARR_STN_CD = 'LHR' OR FSPI.ARR_STN_CD = 'LGW')
AND
RSH.HAUL_CD = 'S'
GROUP BY 1,2,3,4,5,6,8),

/* Competitor Data */
COMP_DATA AS
(SELECT FSPI.ALN_CD,
FSPI.OBSERVATION_DT,
FSPI.DEP_STN_CD,
FSPI.ARR_STN_CD,
FSPI.DEP_DT,
MIN(FSPI.PRICE_VLU) AS MIN_COMP_PRICE
FROM REF_STATION_HAUL RSH

LEFT JOIN FLT_SPOT_PRICE_EACH_WAY FSPI
ON
RSH.UPL_STN_CD = FSPI.DEP_STN_CD
AND
RSH.DSG_STN_CD = FSPI.ARR_STN_CD
WHERE
FSPI.DEP_DT BETWEEN DATE '2018-03-01' AND DATE '2020-02-01'
AND
FSPI.ALN_CD ne 'BA'
AND
(FSPI.DEP_STN_CD = 'LHR' OR FSPI.ARR_STN_CD = 'LGW' OR FSPI.ARR_STN_CD = 'LHR' OR FSPI.ARR_STN_CD = 'LGW')
AND
RSH.HAUL_CD = 'S'
GROUP BY 1,2,3,4,5)

SELECT BA_DATA.OPG_FLT_NO,BA_DATA.DEP_STN_CD AS UPL_STN_CD, BA_DATA.ARR_STN_CD AS DSG_STN_CD,
BA_DATA.DTD,BA_DATA.MIN_BA_PRICE,COMP_DATA.MIN_COMP_PRICE,

CAST( BA_DATA.DEP_DT AS TIMESTAMP(0)) +(BA_DATA.BA_TIME - TIME '00:00:00' HOUR TO SECOND ) SCHED_DEP_TM

FROM BA_DATA 
LEFT JOIN COMP_DATA
ON
BA_DATA.DEP_STN_CD = COMP_DATA.DEP_STN_CD
AND
BA_DATA.ARR_STN_CD = COMP_DATA.ARR_STN_CD
AND
BA_DATA.DEP_DT = COMP_DATA.DEP_DT
AND
BA_DATA.OBSERVATION_DT = COMP_DATA.OBSERVATION_DT

/* To save space, you can restrict DTD range and only use DTDs that are multiples of 7.
   I've commented this out for now. */
/*
DTD <= 42 AND DTD >= 7
AND
(DTD MOD 7)
*/

ORDER BY SCHED_DEP_TM,BA_DATA.OPG_FLT_NO,BA_DATA.DTD
